<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Stego 2FA â€” Generator (Smart TTL + Live Suggestions)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
<!-- libs used by generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
:root {
  --bg1: #050b16;
  --bg2: #0d1727;
  --glass: rgba(255,255,255,0.06);
  --text-main: #e9eef8;
  --muted: #94a3b8;
  --accent1: #7c3aed;
  --accent2: #06b6d4;
  --glow: 0 0 18px rgba(124,58,237,0.5), 0 0 28px rgba(6,182,212,0.3);
  --modal-width: 400px;
}
*{box-sizing:border-box;}
body{
  margin:0;font-family:'Inter',system-ui,sans-serif;
  background:radial-gradient(circle at top left,#0d1727,#050b16);
  color:var(--text-main);
  min-height:100vh;
}
/* HEADER */
header{
  background:linear-gradient(90deg,rgba(124,58,237,0.16),rgba(6,182,212,0.12));
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(255,255,255,0.06);
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 28px;
  box-shadow:0 6px 30px rgba(0,0,0,0.3);
  position:sticky;top:0;z-index:20;
}
.header-left{display:flex;align-items:center;gap:14px;}
.logo{
  width:48px;height:48px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  font-family:'Poppins',sans-serif;font-weight:700;color:#fff;box-shadow:var(--glow);
}
header h1{margin:0;font-size:18px;font-weight:700;}
header p{margin:2px 0 0;color:var(--muted);font-size:13px;}
.header-right button{
  padding:8px 14px;border-radius:10px;border:none;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;
  font-weight:700;cursor:pointer;transition:.18s;
}
.header-right button:hover{transform:translateY(-2px);box-shadow:var(--glow);}

/* MAIN */
.wrap{max-width:1080px;margin:36px auto;display:grid;grid-template-columns:1fr 380px;gap:22px;align-items:start;padding:0 20px;}
.card{
  background:var(--glass);backdrop-filter:blur(12px);border-radius:16px;padding:20px;
  border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.45);
}
label{display:block;font-size:13px;color:#cfe7ff;margin-bottom:6px;font-weight:600;}
input[type=text],input[type=password]{width:100%;padding:12px 14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#e6eef8;}
input:focus{border-color:var(--accent2);box-shadow:0 0 0 4px rgba(6,182,212,0.12);outline:none;}
.small-muted{color:var(--muted);font-size:13px;margin-top:6px;}
.row-actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px;}
button{padding:10px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:all .18s ease;}
.btn-primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;box-shadow:0 6px 22px rgba(124,58,237,0.12);}
.btn-primary:hover{box-shadow:var(--glow);transform:translateY(-3px);}
.btn-ghost{background:rgba(255,255,255,0.03);color:var(--muted);border:1px solid rgba(255,255,255,0.06);}
.btn-ghost:hover{color:white;background:rgba(255,255,255,0.06);border-color:var(--accent2);}
.ttl{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:10px;font-weight:700;}
.ttl.ok{background:rgba(16,185,129,0.12);color:#bff3d6;border:1px solid rgba(16,185,129,0.3);}
.ttl.expired{background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);color:#ffb4b4;}
.canvas-wrap{position:relative;display:inline-block;overflow:hidden;border-radius:12px;box-shadow:0 10px 36px rgba(0,0,0,0.5);}
#stego-canvas{border-radius:12px;transition:filter .25s ease;}
#stego-canvas:hover{filter:brightness(1.06);}
#heatmap-canvas{position:absolute;left:0;top:0;pointer-events:none;mix-blend-mode:screen;border-radius:12px;display:none;}
.pw-meter{display:flex;align-items:center;gap:8px;margin-top:8px;}
#pwMeter{flex:1;height:8px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;}
#pwMeterFill{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .38s ease;}
.pw-suggestions{color:var(--muted);font-size:13px;margin-top:6px;}
.secret-guide{color:var(--muted);font-size:13px;margin-top:6px;}
footer{text-align:center;color:var(--muted);font-size:13px;padding:20px;margin-top:36px;border-top:1px solid rgba(255,255,255,0.04);}
footer span{color:var(--accent2);}

/* Modal (floating process log) */
.modal-bg{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.45);backdrop-filter:blur(6px);z-index:9999;
  opacity:0;pointer-events:none;transition:opacity .26s ease;
}
.modal-bg.visible{display:flex;opacity:1;pointer-events:auto;}
.modal{
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  backdrop-filter:blur(12px);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 10px 40px rgba(2,6,23,0.7);
  width:calc(var(--modal-width));
  max-width:calc(100% - 40px);
  max-height:70vh;
  overflow:hidden;
  transform: translateY(18px) scale(.98);
  opacity:0;
  transition: transform .28s cubic-bezier(.2,.9,.25,1), opacity .28s ease;
}
.modal-bg.visible .modal{ transform: translateY(0) scale(1); opacity:1; }

.modal-header{
  display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.04);
}
.modal-header h3{margin:0;font-size:15px;color:#e7eafc;}
.modal-header button{background:none;border:none;color:#e6eef8;font-size:18px;cursor:pointer;transition:.16s}
.modal-header button:hover{color:var(--accent2);transform:translateY(-2px);}

.modal-body{padding:12px 14px;font-family:ui-monospace,Menlo,Monaco,monospace;font-size:13px;white-space:pre-wrap;color:#d6e0f5;overflow:auto;max-height:calc(70vh - 120px);}
.modal-summary{border-top:1px solid rgba(255,255,255,0.04);padding:10px 14px;color:var(--muted);font-size:13px;background:rgba(255,255,255,0.01);}

@media (max-width:560px){
  .wrap{grid-template-columns:1fr;}
  .modal{ width: calc(92%); }
}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo">S2</div>
    <div>
      <h1>Steganography 2FA â€” Generator</h1>
      <p>Secure token embedding with smart TTL</p>
    </div>
  </div>
  <div class="header-right">
    <button onclick="window.open('https://openai.com','_blank')">Docs</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <label for="secret">Secret / Token to embed</label>
    <input id="secret" type="text" placeholder="e.g. user:alice@example.com" />
    <div id="secretGuide" class="secret-guide">Tip: keep secret short (under 256 bytes) and avoid long sensitive data; e.g. <code>user:alice@example.com</code></div>

    <label for="password" style="margin-top:10px;">Password</label>
    <input id="password" type="password" placeholder="strong password" />
    <div class="pw-meter">
      <div id="pwStrength" class="small-muted">Strength: â€”</div>
      <div id="pwMeter"><i id="pwMeterFill"></i></div>
    </div>
    <div id="pwSuggestions" class="pw-suggestions">Password suggestions will appear here.</div>

    <div class="row-actions">
      <button id="generate" class="btn-primary">Generate Stego QR</button>
      <button id="uploadToken" class="btn-ghost" disabled>Upload & Create Token QR</button>
      <button id="download" class="btn-ghost" disabled>Download PNG</button>
      <button id="copyDataUrl" class="btn-ghost" disabled>Copy Data URL</button>
      <button id="openNew" class="btn-ghost" disabled>Open Image</button>
      <button id="toggleHeatmap" class="btn-ghost" disabled>Show Heatmap</button>
      <div style="margin-left:auto" class="small-muted">QR size: <strong id="qrSize">256</strong> px</div>
    </div>

    <div style="margin-top:16px;">
      <button id="showLog" class="btn-ghost" style="width:100%;">ðŸ§  Show Process Log</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
      <div id="ttlBadge" class="ttl">No token</div>
      <div class="small-muted">Token TTL is computed per generation (smart TTL).</div>
    </div>
  </div>

  <aside>
    <div class="card" style="display:flex;flex-direction:column;align-items:center;gap:10px">
      <div style="font-weight:700">Result Image</div>
      <div class="canvas-wrap">
        <canvas id="stego-canvas" width="256" height="256"></canvas>
        <canvas id="heatmap-canvas" width="256" height="256"></canvas>
      </div>
      <div id="tokenUrl" style="width:100%;word-break:break-all;font-size:13px;color:var(--muted);text-align:center;"></div>
      <div id="tokenQr" style="margin-top:8px;"></div>
    </div>
  </aside>
</div>

<footer>
  Â© 2025 <span>Stego 2FA</span> â€” Secure QR Generator Interface
</footer>

<!-- Floating Modal for Process Log (400 px) -->
<div id="logModal" class="modal-bg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
    <div class="modal-header">
      <h3 id="modalTitle">Process Log</h3>
      <button id="closeModal" aria-label="Close log">&times;</button>
    </div>
    <div class="modal-body" id="processLog"></div>
    <div class="modal-summary" id="logSummary">Summary will appear here + AI voice will speak it.</div>
  </div>
</div>

<script>
/* Full generator logic + upload integration */
/* Note: API_BASE is same origin (empty) because frontend + backend are hosted together on Vercel */
const API_BASE = ''; // same-origin

(function(){
  // DOM refs
  const refs = {
    secret: document.getElementById('secret'),
    secretGuide: document.getElementById('secretGuide'),
    password: document.getElementById('password'),
    pwStrength: document.getElementById('pwStrength'),
    pwMeterFill: document.getElementById('pwMeterFill'),
    pwSuggestions: document.getElementById('pwSuggestions'),
    generateBtn: document.getElementById('generate'),
    uploadTokenBtn: document.getElementById('uploadToken'),
    downloadBtn: document.getElementById('download'),
    copyBtn: document.getElementById('copyDataUrl'),
    openBtn: document.getElementById('openNew'),
    toggleHeatmapBtn: document.getElementById('toggleHeatmap'),
    processLog: document.getElementById('processLog'),
    logSummary: document.getElementById('logSummary'),
    ttlBadge: document.getElementById('ttlBadge'),
    stegoCanvas: document.getElementById('stego-canvas'),
    heatmapCanvas: document.getElementById('heatmap-canvas'),
    qrSizeLabel: document.getElementById('qrSize'),
    showLogBtn: document.getElementById('showLog'),
    logModal: document.getElementById('logModal'),
    closeModal: document.getElementById('closeModal'),
    tokenUrlEl: document.getElementById('tokenUrl'),
    tokenQrEl: document.getElementById('tokenQr'),
  };

  const ctx = refs.stegoCanvas.getContext('2d');
  const QR_SIZE = 256;
  refs.qrSizeLabel.textContent = QR_SIZE;

  // Smart TTL
  let SMART_TTL_MS = 5 * 60 * 1000;
  let currentIat = 0;
  let ttlTimer = null;

  function speakSummary(text){
    const synth = window.speechSynthesis;
    if(!synth) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.pitch = 1; utter.rate = 1; utter.volume = 1;
    const voices = synth.getVoices();
    const female = voices.find(v => /female|woman|Samantha|Google US English|Microsoft|Jenny|Olivia|Alloy/i.test(v.name)) || voices.find(v => /en-US/.test(v.lang));
    if(female) utter.voice = female;
    synth.cancel();
    synth.speak(utter);
  }

  function logLine(msg){
    const d = document.createElement('div');
    d.textContent = msg;
    refs.processLog.appendChild(d);
    refs.processLog.scrollTop = refs.processLog.scrollHeight;
  }
  function clearLog(){ refs.processLog.textContent = ''; refs.logSummary.textContent = ''; }

  function updatePasswordUI(){
    try {
      const pw = refs.password.value || '';
      const res = (window.zxcvbn && pw) ? zxcvbn(pw) : null;
      let score = res ? res.score : (pw ? 1 : -1);
      const labels = ['Very weak','Weak','Fair','Good','Strong'];
      refs.pwStrength.textContent = 'Strength: ' + (score >= 0 ? labels[score] : 'â€”');
      refs.pwMeterFill.style.width = (score >= 0 ? ((score + 1)/5*100)+'%' : '0%');
      if(res && res.feedback){
        let msgs = [];
        if(res.feedback.warning) msgs.push(res.feedback.warning);
        if(res.feedback.suggestions && res.feedback.suggestions.length) msgs.push(...res.feedback.suggestions);
        refs.pwSuggestions.textContent = msgs.length ? msgs.join(' â€” ') : 'No suggestions.';
      } else {
        refs.pwSuggestions.textContent = pw ? 'Type a stronger password for better security.' : 'Password suggestions will appear here.';
      }
    } catch(e){
      refs.pwStrength.textContent = 'Strength: â€”';
      refs.pwMeterFill.style.width = '0%';
      refs.pwSuggestions.textContent = 'Password suggestions will appear here.';
    }
  }

  function updateSecretGuide(){
    const s = refs.secret.value || '';
    const len = new TextEncoder().encode(s).length;
    const parts = [];
    if(!s) parts.push('Enter the secret message');
    else {
      if(len < 6) parts.push('Secret is very short â€” consider adding more context.');
      if(len > 512) parts.push('Secret is long (>512 bytes) â€” consider storing large secrets elsewhere.');
      if(/@/.test(s)) parts.push('Looks like an email-based token â€” good.');
    }
    refs.secretGuide.textContent = parts.length ? parts.join(' ') : 'Secret looks fine.';
  }

  function computeSmartTTL(){
    const base = 5 * 60 * 1000;
    let risk = 0;
    try {
      const pw = refs.password.value || '';
      if(window.zxcvbn){
        const r = zxcvbn(pw);
        risk += (4 - r.score);
      } else {
        if(pw.length < 8) risk += 2;
        else if(pw.length < 12) risk += 1;
      }
    } catch(e){ risk += 1; }
    if(location.protocol === 'file:') risk += 0.5;
    const h = new Date().getHours();
    if(h < 6 || h > 22) risk += 0.5;
    if(risk < 0) risk = 0;
    const reductionMs = Math.round(risk * 30) * 1000;
    const ttl = Math.max(60 * 1000, base - reductionMs);
    return { ttl, risk, reductionMs };
  }

  function startTTL(iat){
    currentIat = iat;
    if(ttlTimer) { clearInterval(ttlTimer); ttlTimer = null; }
    updateTTLUI();
    ttlTimer = setInterval(updateTTLUI, 1000);
  }
  function stopTTL(){
    currentIat = 0;
    if(ttlTimer) { clearInterval(ttlTimer); ttlTimer = null; }
    refs.ttlBadge.textContent = 'No token';
    refs.ttlBadge.className = 'ttl';
  }
  function updateTTLUI(){
    if(!currentIat) { refs.ttlBadge.textContent = 'No token'; refs.ttlBadge.className = 'ttl'; return; }
    const elapsed = Date.now() - currentIat;
    const remaining = SMART_TTL_MS - elapsed;
    if(remaining <= 0){
      refs.ttlBadge.className = 'ttl expired';
      refs.ttlBadge.textContent = 'âŒ Expired';
      refs.downloadBtn.disabled = true;
      refs.copyBtn.disabled = true;
      refs.openBtn.disabled = true;
      refs.toggleHeatmapBtn.disabled = true;
      refs.uploadTokenBtn.disabled = true;
    } else {
      refs.ttlBadge.className = 'ttl ok';
      const m = Math.floor(remaining / 60000);
      const s = Math.floor((remaining % 60000) / 1000);
      refs.ttlBadge.textContent = `âœ… Valid â€” ${m}m ${s}s left`;
    }
  }

  // Stego helpers
  function bitsFromString(str){
    const bytes = new TextEncoder().encode(str);
    const len = bytes.length;
    const header = new Uint8Array(4);
    header[0] = (len >>> 24) & 0xff;
    header[1] = (len >>> 16) & 0xff;
    header[2] = (len >>> 8) & 0xff;
    header[3] = len & 0xff;
    const combined = new Uint8Array(header.length + bytes.length);
    combined.set(header, 0);
    combined.set(bytes, header.length);
    const bits = [];
    for(let i=0;i<combined.length;i++){
      for(let b=7;b>=0;b--) bits.push((combined[i] >> b) & 1);
    }
    return bits;
  }

  function renderHeatmap(bits, width, height){
    const hm = refs.heatmapCanvas;
    hm.width = width; hm.height = height;
    const c = hm.getContext('2d');
    c.clearRect(0,0,width,height);
    const img = c.createImageData(width, height);
    for(let p=0;p<width*height;p++){
      const alpha = bits && bits[p] ? 110 : 0;
      const idx = p * 4;
      img.data[idx] = 255;
      img.data[idx+1] = 40;
      img.data[idx+2] = 40;
      img.data[idx+3] = alpha;
    }
    c.putImageData(img, 0, 0);
  }

  // upload to server and get token
  async function uploadPayloadAndGetToken(payloadObj){
    logLine('Uploading payload to server for token...');
    const resp = await fetch(`${API_BASE}/api/upload`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payload: payloadObj })
    });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error('Upload failed: ' + txt);
    }
    const j = await resp.json();
    return j; // { id, url, expires_in }
  }

  // Generate main
  async function handleGenerate(){
    clearLog();
    refs.downloadBtn.disabled = true;
    refs.copyBtn.disabled = true;
    refs.openBtn.disabled = true;
    refs.toggleHeatmapBtn.disabled = true;
    refs.uploadTokenBtn.disabled = true;
    refs.tokenUrlEl.textContent = '';
    refs.tokenQrEl.innerHTML = '';

    const secret = refs.secret.value.trim();
    const password = refs.password.value;
    if(!secret){ logLine('Error: secret is required.'); return; }
    if(!password){ logLine('Error: password is required.'); return; }

    const { ttl, risk, reductionMs } = computeSmartTTL();
    SMART_TTL_MS = ttl;
    logLine(`Smart TTL computed: ${Math.round(SMART_TTL_MS/1000)}s (risk ${risk}, reduced ${Math.round(reductionMs/1000)}s)`);
    refs.logSummary.textContent = `Smart TTL: ${Math.round(SMART_TTL_MS/1000)}s`;

    logLine('Encrypting payload with AES and generating HMAC...');
    const iat = Date.now();
    const inner = JSON.stringify({ secret, iat });
    const ciphertext = CryptoJS.AES.encrypt(inner, password).toString();
    const hmac = CryptoJS.HmacSHA256(ciphertext, password).toString(CryptoJS.enc.Hex);
    logLine('Payload encrypted successfully.');

    logLine('Generating base QR code (off-screen)...');
    const tmp = document.createElement('div');
    new QRCode(tmp, { text: `stego:${Date.now()}`, width: QR_SIZE, height: QR_SIZE, correctLevel: QRCode.CorrectLevel.H });
    await new Promise(res => setTimeout(res, 80));
    const qrCanvas = tmp.querySelector('canvas');
    if(!qrCanvas){ logLine('Error: failed to render QR canvas.'); return; }
    logLine(`Base QR generated (${qrCanvas.width}x${qrCanvas.height}).`);

    ctx.clearRect(0,0,refs.stegoCanvas.width, refs.stegoCanvas.height);
    ctx.drawImage(qrCanvas, 0, 0, QR_SIZE, QR_SIZE);

    const payloadObj = { ct: ciphertext, hmac, iat };
    const payloadStr = JSON.stringify(payloadObj);
    const bits = bitsFromString(payloadStr);
    logLine(`Embedding ${bits.length} bits into QR... (carrier capacity: ${QR_SIZE * QR_SIZE} bits)`);

    const imageData = ctx.getImageData(0, 0, QR_SIZE, QR_SIZE);
    if(bits.length > QR_SIZE * QR_SIZE){
      logLine('Error: payload too large for carrier.');
      return;
    }
    for(let p=0; p<bits.length; p++){
      const idx = p * 4;
      imageData.data[idx] = (imageData.data[idx] & 0xFE) | bits[p];
    }
    const w = QR_SIZE, h = QR_SIZE;
    const markPositions = [0,2,4];
    for(let i=0;i<markPositions.length;i++){
      const x = w - 3 - i;
      const y = h - 3 - i;
      const px = (y * w + x) * 4;
      imageData.data[px+2] = imageData.data[px+2] ^ 0x01;
    }

    ctx.putImageData(imageData, 0, 0);
    logLine('Embedding finished. Stego image prepared.');
    renderHeatmap(bits, QR_SIZE, QR_SIZE);

    refs.downloadBtn.disabled = false;
    refs.copyBtn.disabled = false;
    refs.openBtn.disabled = false;
    refs.toggleHeatmapBtn.disabled = false;
    refs.uploadTokenBtn.disabled = false;

    startTTL(iat);

    const durationSec = ((Date.now() - iat) / 1000).toFixed(2);
    const ttlMin = (SMART_TTL_MS / 60000).toFixed(2);
    const summaryText = `Smart summary: Token generated in ${durationSec} seconds. Valid for ${ttlMin} minutes.`;
    refs.logSummary.textContent = summaryText;
    speakSummary(summaryText);
    logLine('âœ… Generation complete.');
    logLine(`Carrier pixels: ${QR_SIZE * QR_SIZE}   â€¢   Payload bytes: ${payloadStr.length}`);

    // store lastPayload for upload flow
    window.__lastGeneratedPayload = payloadObj;
    window.__lastGeneratedCanvasDataUrl = refs.stegoCanvas.toDataURL('image/png');
  }

  refs.generateBtn.addEventListener('click', handleGenerate);

  // Upload token flow
  refs.uploadTokenBtn.addEventListener('click', async ()=>{
    if(!window.__lastGeneratedPayload){
      logLine('No generated payload to upload â€” generate first.');
      return;
    }
    try {
      refs.uploadTokenBtn.disabled = true;
      const res = await uploadPayloadAndGetToken(window.__lastGeneratedPayload);
      logLine('Server returned token id: ' + res.id);
      // show token url and generate QR
      refs.tokenUrlEl.textContent = res.url;
      refs.tokenQrEl.innerHTML = '';
      new QRCode(refs.tokenQrEl, { text: res.url, width: 140, height: 140, correctLevel: QRCode.CorrectLevel.H });
      logLine('Token QR generated. Share the token URL or QR with recipient.');
      // note: token expires in res.expires_in seconds
      setTimeout(()=>{ /* no-op */ }, 0);
    } catch (err){
      logLine('Upload failed: ' + (err.message||err));
    } finally {
      refs.uploadTokenBtn.disabled = false;
    }
  });

  // download / copy / open
  refs.downloadBtn.addEventListener('click', () => {
    if(!currentIat || (Date.now() - currentIat > SMART_TTL_MS)){ logLine('Cannot download â€” token expired or missing.'); return; }
    const a = document.createElement('a');
    a.href = refs.stegoCanvas.toDataURL('image/png');
    a.download = `stego-${Date.now()}.png`;
    a.click();
  });
  refs.copyBtn.addEventListener('click', async () => {
    if(!currentIat || (Date.now() - currentIat > SMART_TTL_MS)){ logLine('Cannot copy â€” token expired or missing.'); return; }
    try {
      await navigator.clipboard.writeText(refs.stegoCanvas.toDataURL('image/png'));
      logLine('Data URL copied to clipboard.');
    } catch(e){
      logLine('Copy failed: ' + (e.message || e));
    }
  });
  refs.openBtn.addEventListener('click', () => {
    if(!currentIat || (Date.now() - currentIat > SMART_TTL_MS)){ logLine('Cannot open â€” token expired or missing.'); return; }
    window.open(refs.stegoCanvas.toDataURL('image/png'), '_blank');
  });

  refs.toggleHeatmapBtn.addEventListener('click', () => {
    if(refs.heatmapCanvas.style.display === 'none' || refs.heatmapCanvas.style.display === ''){
      refs.heatmapCanvas.style.display = 'block';
      refs.toggleHeatmapBtn.textContent = 'Hide Heatmap';
    } else {
      refs.heatmapCanvas.style.display = 'none';
      refs.toggleHeatmapBtn.textContent = 'Show Heatmap';
    }
  });

  // UI binders
  refs.password.addEventListener('input', updatePasswordUI);
  refs.secret.addEventListener('input', updateSecretGuide);
  refs.heatmapCanvas.style.display = 'none';
  refs.downloadBtn.disabled = true;
  refs.copyBtn.disabled = true;
  refs.openBtn.disabled = true;
  refs.toggleHeatmapBtn.disabled = true;
  refs.uploadTokenBtn.disabled = true;
  updatePasswordUI();
  updateSecretGuide();

  // modal controls
  refs.showLogBtn.addEventListener('click', () => {
    refs.logModal.classList.add('visible');
    refs.logModal.setAttribute('aria-hidden','false');
  });
  refs.closeModal.addEventListener('click', ()=>{ refs.logModal.classList.remove('visible'); refs.logModal.setAttribute('aria-hidden','true'); });
  refs.logModal.addEventListener('click', (ev)=>{ if(ev.target === refs.logModal) { refs.logModal.classList.remove('visible'); refs.logModal.setAttribute('aria-hidden','true'); } });

})();
</script>
</body>
</html>
